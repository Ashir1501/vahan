{% extends '../adminTemplates/base.html' %}
{% load static %}

{% block content %}
{% if messages %}
{% for message in messages %}
{% if message.tags == 'success' %}
<script>
    console.log('{{message}}')
    Swal.fire({
        position: "center",
        icon: "success",
        title: "{{message}}",
        showConfirmButton: false,
        timer: 1500
    });
</script>
{% endif %}
{% if message.tags == 'error' %}
<script>
    Swal.fire({
        position: "center",
        icon: "error",
        title: "{{message}}",
        showConfirmButton: false,
        timer: 2000
    });
</script>
{% endif %}
{% endfor %}
{% endif %}
{{data}}
<div>

    <div style="margin: 10px;">
        <div class="container-fixed">
            <div class="grid gap-5 lg:gap-7.5">
                <div class="card card-grid min-w-full">
                    <div class="card-header py-5 flex-wrap">
                        <h3 class="card-title">
                            Rides Details

                            <!-- <div style="display: inline-block;" class="ml-5">
                                <button class="btn btn-danger btn-sm" type="button" onclick="cancelRidePending()">
                                    <i class="ki-filled ki-cross-circle"></i>
                                    Cancel
                                </button>
                            </div> -->

                            <!-- <div style="display: inline-block;" class="ml-5">
                                <button class="btn btn-light btn-sm" type="button" onclick="approvedRide()">
                                    Approve
                                </button>
                            </div> -->
                        </h3>
                        <div class="flex gap-6">
                            <div class="relative">
                                <i
                                    class="ki-outline ki-magnifier leading-none text-md text-gray-500 absolute top-1/2 left-0 -translate-y-1/2 ml-3"></i>
                                <input class="input input-sm pl-8" onkeyup="filterTableTypevendor_ride()"
                                    placeholder="Search" id="searchvendor_ride" type="text" />
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div data-datatable="true" data-datatable-page-size="5">
                            <div class="scrollable-x-auto">
                                <table class="table table-auto table-border" data-datatable-table="true"
                                    id="vendor_ride_table">
                                    <thead>
                                        <tr>
                                            <!-- <th class="w-[60px]">
                                                <input class="checkbox checkbox-sm" data-datatable-check="true"
                                                    type="checkbox" />
                                            </th> -->
                                            <th class="w-[20px]"></th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Status</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Pickup</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Drop</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Driver</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Pickup date</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Pickup at</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Return Date</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[10px]"></th>
                                            <th class="w-[80px]"> Car </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Car Model</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Fare</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Duration</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">KMS</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                            <th class="w-[80px]">
                                                <span class="sort asc">
                                                    <span class="sort-label">Customer Name</span>
                                                    <span class="sort-icon"></span>
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rideData in ridesData %}
                                        {% if rideData.ride_status == 'confirmed' or rideData.ride_status == 'approved'
                                        or rideData.ride_status == 'cancelled' or rideData.ride_status == 'assigned' %}
                                        <tr>

                                            <td>
                                                <a class="btn btn-sm btn-light"
                                                    data-modal-toggle="#modal_{{ rideData.hashed_id }}_vendor_ride">
                                                    <i class="ki-filled ki-delivery-3"></i>Assign
                                                </a>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        {% if rideData.ride_status == 'confirmed' %}
                                                        <span class="badge badge-outline badge-info">{{
                                                            rideData.ride_status }}</span>
                                                        {% elif rideData.ride_status == 'cancelled' %}
                                                        <span class="badge badge-outline badge-danger">
                                                            {{ rideData.ride_status }}
                                                        </span>
                                                        {% elif rideData.ride_status == 'approved' %}
                                                        <span class="badge badge-outline badge-warning">
                                                            {{ rideData.ride_status }}
                                                        </span>
                                                        {% else %}
                                                        <span class="badge badge-outline badge-success">
                                                            {{ rideData.ride_status }}
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.route.pickup_location }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.route.drop_location }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td title="{{ rideData.driver.email }}">
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">
                                                            {{ rideData.driver.first_name }} {{
                                                            rideData.driver.last_name }}
                                                        </a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.pickup_date }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.pickup_at }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.return_date }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.route.status }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{rideData.car.car_model
                                                            }}/ ({{rideData.car.car_brand}})</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.route.car_type.car_type }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.fare }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.route.duration }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">{{
                                                            rideData.route.kms }}</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td title="{{ rideData.customer.email }}">
                                                <div class="flex items-center gap-2.5">
                                                    <div class="flex flex-col gap-0.5">
                                                        <a class="leading-none font-semibold text-sm text-gray-900 ">
                                                            {{ rideData.customer.first_name }} {{
                                                            rideData.customer.last_name }}
                                                        </a>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Modal -->
                                        <div class="modal" data-modal="true"
                                            id="modal_{{ rideData.hashed_id }}_vendor_ride">
                                            <form id="carEditForm_{{ rideData.hashed_id }}" method="post"
                                                enctype="multipart/form-data" action="{% url 'assign-driver' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="ride_id" value="{{ rideData.hashed_id }}">
                                                <div class="modal-content max-w-[600px] top-[10%]">
                                                    <div class="modal-header">
                                                        <h3 class="modal-title">Ride</h3>
                                                        <button type="button" class="btn btn-xs btn-icon btn-light"
                                                            data-modal-dismiss="true">
                                                            <i class="ki-outline ki-cross"></i>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <input type="hidden" name="driver_id"
                                                            id="driverId_{{ rideData.hashed_id }}">
                                                        <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                            <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                                Driver
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            <input class="input"
                                                                id="driverInput_{{ rideData.hashed_id }}"
                                                                placeholder="Driver" type="text"
                                                                list="driverList_{{ rideData.hashed_id }}"
                                                                autocomplete="off" />
                                                            <datalist id="driverList_{{ rideData.hashed_id }}">
                                                                {% for driverData in driverData %}
                                                                {% if driverData.user_type == 'Driver'%}
                                                                <option data-id="{{ driverData.hashed_id }}"
                                                                    value="{{ driverData.first_name }} {{ driverData.last_name }} /{{ driverData.email }}">
                                                                </option>
                                                                {% endif%}
                                                                {% endfor %}
                                                            </datalist>
                                                        </div>
                                                        <input type="hidden" name="car_id"
                                                            id="carId_{{ rideData.hashed_id }}">
                                                        <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                            <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                                Car
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            <input class="input" id="carInput_{{ rideData.hashed_id }}"
                                                                placeholder="Cars" type="text"
                                                                list="CarsList_{{ rideData.hashed_id }}"
                                                                autocomplete="off" />
                                                            <datalist id="CarsList_{{ rideData.hashed_id }}">
                                                                {% for cars in cars_data %}
                                                                {% if cars.Car_type.car_type ==
                                                                rideData.route.car_type.car_type %}
                                                                <option data-id="{{ cars.hashed_id }}"
                                                                    value="{{ cars.car_model }} / {{ cars.car_brand }} / {{ cars.Car_type.car_type }}">
                                                                </option>
                                                                {% endif %}
                                                                {% endfor %}
                                                            </datalist>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer justify-end" style="margin: 10px;">
                                                        <div class="flex gap-4">
                                                            <button type="button" class="btn btn-light"
                                                                data-modal-dismiss="true">Cancel</button>
                                                            <button type="submit"
                                                                class="btn btn-primary">Submit</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>

                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>

                            </div>
                            <div
                                class="card-footer justify-center md:justify-between flex-col md:flex-row gap-3 text-gray-600 text-2sm font-medium">
                                <div class="flex items-center gap-2">
                                    Show
                                    <select class="select select-sm w-16" data-datatable-size="true"
                                        name="perpage"></select>
                                    per page
                                </div>
                                <div class="flex items-center gap-4">
                                    <span data-datatable-info="true"></span>
                                    <div class="pagination" data-datatable-pagination="true"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    function filterTableTypevendor_ride() {
        // Get the value of the input field
        var input = document.getElementById('searchvendor_ride');
        var filter = input.value.toUpperCase();
        var table = document.getElementById('vendor_ride_table');
        var tr = table.getElementsByTagName('tr');

        // Loop through all table rows
        for (var i = 1; i < tr.length; i++) {
            var td = tr[i].getElementsByTagName('td');
            var rowContainsFilter = false;

            // Loop through all cells in the current row
            for (var j = 0; j < td.length; j++) {
                var cell = td[j];
                if (cell) {
                    var txtValue = cell.textContent || cell.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        rowContainsFilter = true;
                        break; // No need to check further cells if one matches
                    }
                }
            }

            // Display or hide the row based on whether it contains the filter text
            if (rowContainsFilter) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }
    }


    // custom.js
    // custom.js
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('input[id^="driverInput_"]').forEach(function (input) {
            input.addEventListener('change', function () {
                var inputId = this.id;
                var modalId = inputId.split('_')[1]; // Extract unique identifier from ID
                var listId = 'driverList_' + modalId;
                var hiddenInputId = 'driverId_' + modalId;

                var inputElement = document.getElementById(inputId);
                var listElement = document.getElementById(listId);
                var hiddenInputElement = document.getElementById(hiddenInputId);

                var inputValue = inputElement.value.trim().toLowerCase();
                var options = listElement.options;

                hiddenInputElement.value = ""; // Reset hidden input

                // Loop through options to find a match with the input value
                for (var i = 0; i < options.length; i++) {
                    var optionValue = options[i].value.trim().toLowerCase();

                    if (optionValue === inputValue) {
                        hiddenInputElement.value = options[i].getAttribute('data-id');
                        console.log("Driver ID found and set: ", hiddenInputElement.value);
                        break;
                    }
                }

                if (!hiddenInputElement.value) {
                    console.log("No matching Driver ID found for input: ", inputValue);
                }
            });
        });

        document.querySelectorAll('input[id^="carInput_"]').forEach(function (input) {
            input.addEventListener('change', function () {
                var inputId = this.id;
                var modalId = inputId.split('_')[1]; // Extract unique identifier from ID
                var listId = 'CarsList_' + modalId;
                var hiddenInputId = 'carId_' + modalId;

                var inputElement = document.getElementById(inputId);
                var listElement = document.getElementById(listId);
                var hiddenInputElement = document.getElementById(hiddenInputId);

                if (!inputElement || !listElement || !hiddenInputElement) {
                    console.error(`One or more elements not found: inputId=${inputId}, listId=${listId}, hiddenInputId=${hiddenInputId}`);
                    return;
                }

                var inputValue = inputElement.value.trim().toLowerCase();
                var options = listElement.options;

                hiddenInputElement.value = ""; // Reset hidden input

                // Loop through options to find a match with the input value
                for (var i = 0; i < options.length; i++) {
                    var optionValue = options[i].value.trim().toLowerCase();

                    if (optionValue === inputValue) {
                        hiddenInputElement.value = options[i].getAttribute('data-id');
                        console.log("Car ID found and set: ", hiddenInputElement.value);
                        break;
                    }
                }

                if (!hiddenInputElement.value) {
                    console.log("No matching Car ID found for input: ", inputValue);
                }
            });
        });

    });


</script>
{% endblock %}