{% extends 'adminTemplates/base.html' %}
{% load static %}

{% block content %}
{% if messages %}
    {% for message in messages %}
        {% if message.tags == 'success' %}
            <script>
                console.log('{{message}}')
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "{{message}}",
                    showConfirmButton: false,
                    timer: 1500
                });
            </script>
        {% endif %}
        {% if message.tags == 'error' %}
            <script>
                Swal.fire({
                    position: "center",
                    icon: "error",
                    title: "{{message}}",
                    showConfirmButton: false,
                    timer: 2000
                });
            </script>
        {% endif %}
    {% endfor %}
{% endif %}

<div>
    <div>
        <div>
            <!-- Tab Buttons -->
            <div class="tabs mb-5 ms-5" data-tabs="true">
                <button class="tab active" data-tab-toggle="#PendingPage"><b>Pending</b></button>
                <button class="tab" data-tab-toggle="#ConfirmedPage"><b>Confirmed</b></button>
                <button class="tab" data-tab-toggle="#CancelledPage"><b>Cancelled</b></button>
            </div>
            <!-- Pending Tab Start -->
            <div class="" id="PendingPage">
                <div style="margin: 20px;">
                    
                    <div style="margin: 10px;">
                        <div class="container-fixed">
                            <div class="grid gap-5 lg:gap-7.5">
                                <div class="card card-grid min-w-full">
                                    <div class="card-header py-5 flex-wrap">
                                        <h3 class="card-title">
                                            Pending Rides
                                            
                                            <div style="display: inline-block;" class="ml-5">
                                                <button class="btn btn-danger btn-sm" type="button" onclick="DeleteCarType()">
                                                    <i class="ki-filled ki-cross-circle"></i>
                                                    Cancel
                                                </button>
                                            </div>
                                            
                                        </h3>
                                        <div class="flex gap-6">
                                            <div class="relative">
                                                <i class="ki-outline ki-magnifier leading-none text-md text-gray-500 absolute top-1/2 left-0 -translate-y-1/2 ml-3"></i>
                                                <input class="input input-sm pl-8" onkeyup="filterTableTypePending()" placeholder="Search" id="searchPending" type="text" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div data-datatable="true" data-datatable-page-size="5">
                                            <div class="scrollable-x-auto">
                                                <table class="table table-auto table-border" data-datatable-table="true" id="Pending_table">
                                                    <thead>
                                                        <tr>
                                                            <th class="w-[60px]">
                                                                <input class="checkbox checkbox-sm" data-datatable-check="true" type="checkbox" />
                                                            </th>
                                                            <th class="w-[20px]"></th>
                                                            <th class="w-[80px]"> 
                                                                <span class="sort asc">
                                                                    <span class="sort-label">
                                                                        Driver Name
                                                                    </span>
                                                                    <span class="sort-icon">
                                                                    </span>
                                                                </span>
                                                                
                                                            </th>
                                                            <th class="w-[80px]"> 
                                                                <span class="sort asc">
                                                                    <span class="sort-label">
                                                                        customer Name
                                                                    </span>
                                                                    <span class="sort-icon">
                                                                    </span>
                                                                </span>
                                                                
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for rideData in ridesData %}
                                                        {% if not rideData.ride_status == 'cancelled' and not rideData.ride_status == 'Started' and not rideData.ride_status == 'completed' and not rideData.ride_status == 'confirmed' %}
                                                        <tr>
                                                            <td>
                                                                <input class="checkbox checkbox-sm" data-datatable-row-check="true" type="checkbox" id="checkBOX_{{ rideData.id }}" value="" />
                                                            </td>
                                                            <td>
                                                                <a class="btn btn-sm btn-light" data-modal-toggle="#modal_{{ rideData.id }}_pending"><i class="ki-filled ki-delivery-3"></i>Assign</a>
                                                            </td>
                                                            <td>
                                                                <div class="flex items-center gap-2.5">
                                                                    <div class="flex flex-col gap-0.5">
                                                                        <a class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">{{ rideData.driver.name }}</a>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="flex items-center gap-2.5">
                                                                    <div class="flex flex-col gap-0.5">
                                                                        <a class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">{{ rideData.return_date }}</a>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    
                                                        <div class="modal" data-modal="true" id="modal_{{ rideData.id }}_pending">
                                                            <form id="carEditForm_{{ rideData.id }}" method="post" enctype="multipart/form-data" action="{% url 'assign-driver' %}">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="ride_id" value="{{ rideData.id }}">
                                                                <div class="modal-content max-w-[600px] top-[10%]">
                                                                    <div class="modal-header">
                                                                        <h3 class="modal-title">Edit {{ rideData.pickup_date }}</h3>
                                                                        <button type="button" class="btn btn-xs btn-icon btn-light" data-modal-dismiss="true">
                                                                            <i class="ki-outline ki-cross"></i>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <input type="hidden" name="driver_id" id="driverId_{{ rideData.id }}">
                                                                        <div class="flex flex-col lg:flex-row lg:items-center gap-2.5">
                                                                            <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                                                Driver
                                                                                <span class="text-danger">*</span>
                                                                            </label>
                                                                            <input class="input" id="driverInput_{{ rideData.id }}" placeholder="Driver" type="text" list="driverList_{{ rideData.id }}" autocomplete="off"/>
                                                                            <datalist id="driverList_{{ rideData.id }}">
                                                                                {% for driverData in driverData %}
                                                                                    <option data-id="{{ driverData.id }}" value="{{ driverData.name }}"></option>
                                                                                {% endfor %}
                                                                            </datalist>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer justify-end" style="margin: 10px;">
                                                                        <div class="flex gap-4">
                                                                            <button type="button" class="btn btn-light" data-modal-dismiss="true">Cancel</button>
                                                                            <button type="submit" class="btn btn-primary">Submit</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                            
                                                        </div>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                    
                                                </table>
                                            </div>
                                            <div class="card-footer justify-center md:justify-between flex-col md:flex-row gap-3 text-gray-600 text-2sm font-medium">
                                                <div class="flex items-center gap-2">
                                                    Show
                                                    <select class="select select-sm w-16" data-datatable-size="true" name="perpage"></select>
                                                    per page
                                                </div>
                                                <div class="flex items-center gap-4">
                                                    <span data-datatable-info="true"></span>
                                                    <div class="pagination" data-datatable-pagination="true"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Confirmed Tab Start -->
            <div class="hidden" id="ConfirmedPage">
                <div style="margin: 20px;">
                    
                    <div style="margin: 10px;">
                        <div class="container-fixed">
                            <div class="grid gap-5 lg:gap-7.5">
                                <div class="card card-grid min-w-full">
                                    <div class="card-header py-5 flex-wrap">
                                        <h3 class="card-title">
                                            Confirmed Rides
                                            <div style="display: inline-block;" class="ml-5">
                                                <button class="btn btn-danger btn-sm" type="button" onclick="DeleteCarType()">
                                                    <i class="ki-filled ki-cross-circle"></i>
                                                    Cancel
                                                </button>
                                            </div>
                                        </h3>
                                        <div class="flex gap-6">
                                            <div class="relative">
                                                <i class="ki-outline ki-magnifier leading-none text-md text-gray-500 absolute top-1/2 left-0 -translate-y-1/2 ml-3"></i>
                                                <input class="input input-sm pl-8" onkeyup="filterTableTypeConfirmed()" placeholder="Search" id="searchConfirmed" type="text" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div data-datatable="true" data-datatable-page-size="5">
                                            <div class="scrollable-x-auto">
                                                <table class="table table-auto table-border" data-datatable-table="true" id="Confirmed_table">
                                                    <thead>
                                                        <tr>
                                                            <th class="w-[60px]">
                                                                <input class="checkbox checkbox-sm" data-datatable-check="true" type="checkbox" />
                                                            </th>
                                                            <th class="w-[60px]"></th>
                                                            <th class="w-[80px]"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for rideData in ridesData %}
                                                        {% if not rideData.ride_status == 'cancelled' and not rideData.ride_status == 'Started' and not rideData.ride_status == 'completed' and not rideData.ride_status == 'assigned' and not rideData.ride_status == 'declined' %}
                                                        <tr>
                                                            <td>
                                                                <input class="checkbox checkbox-sm" data-datatable-row-check="true" type="checkbox" id="checkBOX" value="" />
                                                            </td>
                                                            <td>
                                                                <a class="btn btn-sm btn-light" data-modal-toggle="#modal_{{RideData.id}}_confirmed"><i class="ki-filled ki-delivery-3"></i></i>Assign</a>
                                                                <!-- <button class="btn btn-sm btn-danger" onclick="DeleteCarType({{carType.id}})">Delete</button> -->
                                                            </td>
                                                            <td>
                                                                <div class="flex items-center gap-2.5">
                                                                    <div class="flex flex-col gap-0.5">
                                                                        <a class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">{{ rideData.driver.name }}</a>
                                                                        <!-- <span class="text-2sm text-gray-600">jk</span> -->
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="flex items-center gap-2.5">
                                                                    <div class="flex flex-col gap-0.5">
                                                                        <a class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">{{ rideData.customer.name }}</a>
                                                                        <span class="text-2sm text-gray-600">jk</span>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            
                                                        </tr>
                                                        
                                                        <div class="modal" data-modal="true" id="modal_{{RideData.id}}_confirmed">
                                                            <form method="post" action="{% url 'assign-driver' %}">
                                                                        {% csrf_token %}
                                                                <input type="hidden" name="ride_id" value="{{rideData.id}}">
                                                                <div class="modal-content max-w-[600px] top-[10%]">
                                                                    <div class="modal-header">
                                                                        <h3 class="modal-title">Edit {{RideData.pickup_date}}</h3>
                                                                        <button type="button" class="btn btn-xs btn-icon btn-light" data-modal-dismiss="true">
                                                                            <i class="ki-outline ki-cross"></i>
                                                                        </button>
                                                                    </div>
                                                                    
                                                                    <label class="form-label flex-shrink-0 w-full lg:w-auto">
                                                                        Driver
                                                                        <span class="text-danger">*</span>
                                                                    </label>
                                                                    <input type="hidden" name="driver_id" id="driver_id_{{ rideData.id }}">
                                                                    <input class="input w-full" type="text" id="user_input_{{ rideData.id }}" placeholder="type name or email..." autocomplete="off" style="width: 100%;">
                                                                    <ul id="driver_list_{{ rideData.id }}" style="display:none; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; position: absolute; top: 100%; left: 0; right: 0; background-color: white; list-style-type: none; padding: 0; margin: 0; z-index: 1000; border-radius: 20px;"></ul>
                                                                    <div class="modal-footer justify-end" style="margin: 10px;">
                                                                        <div class="flex gap-4">
                                                                            <button type="button" class="btn btn-light" data-modal-dismiss="true">Cancel</button>
                                                                            <button type="submit" class="btn btn-primary">Submit</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="card-footer justify-center md:justify-between flex-col md:flex-row gap-3 text-gray-600 text-2sm font-medium">
                                                <div class="flex items-center gap-2">
                                                    Show
                                                    <select class="select select-sm w-16" data-datatable-size="true" name="perpage"></select>
                                                    per page
                                                </div>
                                                <div class="flex items-center gap-4">
                                                    <span data-datatable-info="true"></span>
                                                    <div class="pagination" data-datatable-pagination="true"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cancelled Tab Start -->
            <div class="hidden" id="CancelledPage">
                <div style="margin: 20px;">
                    
                    <div style="margin: 10px;">
                        <div class="container-fixed">
                            <div class="grid gap-5 lg:gap-7.5">
                                <div class="card card-grid min-w-full">
                                    <div class="card-header py-5 flex-wrap">
                                        <h3 class="card-title">
                                            Cancelled Rides
                                            <!-- <div style="display: inline-block;" class="ml-5">
                                                <button class="btn btn-danger btn-sm" type="button" onclick="DeleteCarType()">
                                                    <i class="ki-filled ki-cross-circle"></i>
                                                    Cancel
                                                </button>
                                            </div> -->
                                        </h3>
                                        <div class="flex gap-6">
                                            <div class="relative">
                                                <i class="ki-outline ki-magnifier leading-none text-md text-gray-500 absolute top-1/2 left-0 -translate-y-1/2 ml-3"></i>
                                                <input class="input input-sm pl-8" onkeyup="filterTableTypeCancelled()" placeholder="Search" id="searchCancelled" type="text" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div data-datatable="true" data-datatable-page-size="5">
                                            <div class="scrollable-x-auto">
                                                <table class="table table-auto table-border" data-datatable-table="true" id="Cancelled_table">
                                                    <thead>
                                                        <tr>
                                                            <!-- <th class="w-[60px]">
                                                                <input class="checkbox checkbox-sm" data-datatable-check="true" type="checkbox" />
                                                            </th> -->
                                                            
                                                            <th class="w-[80px]"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for rideData in ridesData %}
                                                        {% if not rideData.ride_status == 'assigned' and not rideData.ride_status == 'Started' and not rideData.ride_status == 'completed' and not rideData.ride_status == 'confirmed' and not rideData.ride_status == 'declined' %}
                                                        <tr>
                                                            <!-- <td>
                                                                <input class="checkbox checkbox-sm" data-datatable-row-check="true" type="checkbox" id="checkBOX" value="" />
                                                            </td>
                                                            -->
                                                            <td>
                                                                <div class="flex items-center gap-2.5">
                                                                    <div class="flex flex-col gap-0.5">
                                                                        <a class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">{{ rideData.driver.name }}</a>
                                                                        <!-- <span class="text-2sm text-gray-600">jk</span> -->
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="flex items-center gap-2.5">
                                                                    <div class="flex flex-col gap-0.5">
                                                                        <a class="leading-none font-semibold text-sm text-gray-900 hover:text-primary">{{ rideData.customer.name }}</a>
                                                                        <span class="text-2sm text-gray-600">jk</span>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            
                                                        </tr>
                                                        
                                                     
                                                        {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="card-footer justify-center md:justify-between flex-col md:flex-row gap-3 text-gray-600 text-2sm font-medium">
                                                <div class="flex items-center gap-2">
                                                    Show
                                                    <select class="select select-sm w-16" data-datatable-size="true" name="perpage"></select>
                                                    per page
                                                </div>
                                                <div class="flex items-center gap-4">
                                                    <span data-datatable-info="true"></span>
                                                    <div class="pagination" data-datatable-pagination="true"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cancelled Tab End -->
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

function filterTableTypePending() {
    // Get the value of the input field
    var input = document.getElementById('searchPending');
    var filter = input.value.toUpperCase();
    var table = document.getElementById('Pending_table');
    var tr = table.getElementsByTagName('tr');
    
    // Loop through all table rows
    for (var i = 1; i < tr.length; i++) {
        var td = tr[i].getElementsByTagName('td');
        var rowContainsFilter = false;

        // Loop through all cells in the current row
        for (var j = 0; j < td.length; j++) {
            var cell = td[j];
            if (cell) {
                var txtValue = cell.textContent || cell.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    rowContainsFilter = true;
                    break; // No need to check further cells if one matches
                }
            }
        }

        // Display or hide the row based on whether it contains the filter text
        if (rowContainsFilter) {
            tr[i].style.display = '';
        } else {
            tr[i].style.display = 'none';
        }
    }
}

function filterTableTypeConfirmed() {
    // Get the value of the input field
    var input = document.getElementById('searchConfirmed');
    var filter = input.value.toUpperCase();
    var table = document.getElementById('Confirmed_table');
    var tr = table.getElementsByTagName('tr');
    
    // Loop through all table rows
    for (var i = 1; i < tr.length; i++) {
        var td = tr[i].getElementsByTagName('td');
        var rowContainsFilter = false;

        // Loop through all cells in the current row
        for (var j = 0; j < td.length; j++) {
            var cell = td[j];
            if (cell) {
                var txtValue = cell.textContent || cell.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    rowContainsFilter = true;
                    break; // No need to check further cells if one matches
                }
            }
        }

        // Display or hide the row based on whether it contains the filter text
        if (rowContainsFilter) {
            tr[i].style.display = '';
        } else {
            tr[i].style.display = 'none';
        }
    }
}

function filterTableTypeCancelled() {
    // Get the value of the input field
    var input = document.getElementById('searchCancelled');
    var filter = input.value.toUpperCase();
    var table = document.getElementById('Cancelled_table');
    var tr = table.getElementsByTagName('tr');
    
    // Loop through all table rows
    for (var i = 1; i < tr.length; i++) {
        var td = tr[i].getElementsByTagName('td');
        var rowContainsFilter = false;

        // Loop through all cells in the current row
        for (var j = 0; j < td.length; j++) {
            var cell = td[j];
            if (cell) {
                var txtValue = cell.textContent || cell.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    rowContainsFilter = true;
                    break; // No need to check further cells if one matches
                }
            }
        }

        // Display or hide the row based on whether it contains the filter text
        if (rowContainsFilter) {
            tr[i].style.display = '';
        } else {
            tr[i].style.display = 'none';
        }
    }
}

// custom.js
// custom.js
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[id^="driverInput_"]').forEach(function(input) {
        input.addEventListener('change', function() {
            var inputId = this.id;
            var modalId = inputId.split('_')[1]; // Extract unique identifier from ID
            var listId = 'driverList_' + modalId;
            var hiddenInputId = 'driverId_' + modalId;

            var inputElement = document.getElementById(inputId);
            var listElement = document.getElementById(listId);
            var hiddenInputElement = document.getElementById(hiddenInputId);

            var inputValue = inputElement.value;
            var options = listElement.options;

            hiddenInputElement.value = ""; // Reset hidden input

            // Loop through options to find a match with the input value
            for (var i = 0; i < options.length; i++) {
                if (options[i].value === inputValue) {
                    hiddenInputElement.value = options[i].getAttribute('data-id');
                    console.log("ID found and set: ", hiddenInputElement.value);
                    break;
                }
            }

            // Debugging log to check the result
            if (!hiddenInputElement.value) {
                console.log("No matching ID found for input: ", inputValue);
            }
        });
    });
});

</script>
{% endblock %}
